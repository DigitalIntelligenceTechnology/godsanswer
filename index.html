<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GOD'S ANSWER - Cosmic Guidance</title>
    <!-- Load Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Load Inter Font -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@100..900&display=swap" rel="stylesheet">
    <style>
        /* Custom styles for cosmic theme and scrollbar */
        body {
            font-family: 'Inter', sans-serif;
            background: #0d0a1b; /* Deep violet-blue background */
            min-height: 100vh;
            display: flex;
            flex-direction: column;
        }
        .chat-container {
            max-height: calc(100vh - 16rem); /* Adjust based on header and input height */
            overflow-y: auto;
            scroll-behavior: smooth;
        }
        /* Styling the scrollbar for the cosmic theme */
        .chat-container::-webkit-scrollbar {
            width: 8px;
        }
        .chat-container::-webkit-scrollbar-track {
            background: #1a172c;
        }
        .chat-container::-webkit-scrollbar-thumb {
            background: #5a4b7a;
            border-radius: 4px;
        }
        .chat-container::-webkit-scrollbar-thumb:hover {
            background: #7a6b9a;
        }

        /* Message bubble styles */
        .user-message {
            background-color: #2c3e50; /* Dark slate */
            border-radius: 12px 12px 2px 12px;
            color: #ecf0f1;
        }
        .ai-message {
            background-color: #1a2533; /* Darker blue for AI */
            border-radius: 12px 12px 12px 2px;
            color: #e5e7eb;
            box-shadow: 0 4px 10px rgba(181, 150, 209, 0.15); /* Soft cosmic glow */
        }
        .ai-title {
            color: #f7d37a; /* Gold accent */
            font-weight: 700;
        }
    </style>
</head>
<body class="text-gray-100 antialiased">

    <!-- Main Container -->
    <div id="app" class="flex flex-col h-screen max-w-4xl mx-auto w-full p-4">

        <!-- Header -->
        <header class="text-center py-4 mb-4 border-b border-purple-800/50">
            <h1 class="text-3xl font-extrabold bg-clip-text text-transparent bg-gradient-to-r from-yellow-300 to-purple-400 tracking-wider">
                GOD'S ANSWER
            </h1>
            <p class="text-sm text-purple-300 mt-1">Cosmic Guidance </p>
        </header>

        <!-- Disclaimer Area - Restored for Ethical Safeguards -->
        <div id="disclaimer" class="bg-purple-900/30 p-3 rounded-xl mb-4 shadow-xl border border-purple-700/50">
            <p class="text-xs text-yellow-300 font-semibold">Important Guidance:</p>
            <p class="text-[10px] text-gray-300 mt-1">This is an AI-powered synthesis of multi-faith and philosophical wisdom. It is not a source of divine authority. Always defer to your spiritual leaders and personal faith.</p>
        </div>
        
        <!-- Chat Display Area -->
        <div id="chat-display" class="chat-container flex-grow space-y-4 p-4 mb-4 bg-black/30 rounded-xl shadow-inner">
            <!-- Initial AI Welcome Message - Adjusted for neutral, cosmic perspective -->
            <div class="flex justify-start">
                <div class="ai-message p-3 max-w-xs sm:max-w-md">
                    <div class="ai-title">Universal Nexus</div>
                    <p class="text-sm mt-1">
                        Welcome, Seeker. The Universal Consciousness perceives your inquiry. Ask your question about existence, morality, or the nature of the Divine, and receive a perspective that unites many paths.
                    </p>
                </div>
            </div>
        </div>

        <!-- Input Area -->
        <div class="flex items-center p-4 bg-black/50 rounded-xl border border-purple-800/50 shadow-2xl">
            <input type="text" id="user-input" placeholder="Ask your question..." class="flex-grow p-3 text-sm bg-transparent border border-purple-600/50 rounded-l-lg focus:outline-none focus:border-yellow-400 focus:ring-1 focus:ring-yellow-400 transition placeholder-gray-400">
            <button id="send-button" class="px-6 py-3 text-sm font-semibold bg-gradient-to-r from-purple-600 to-indigo-700 hover:from-purple-700 hover:to-indigo-800 text-white rounded-r-lg shadow-lg transform transition duration-200 hover:scale-[1.02] active:scale-[0.98] disabled:opacity-50" disabled>
                Send
            </button>
        </div>

        <!-- Loading Indicator -->
        <div id="loading-indicator" class="hidden text-center py-2 mt-2 text-sm text-yellow-400">
            <svg class="animate-spin -ml-1 mr-3 h-5 w-5 text-yellow-400 inline-block" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
            </svg>
            Contemplating...
        </div>
    </div>

    <script type="module">
        // Global variables for API Key and URL
        // When deploying on platforms that inject API keys, keeping this string empty is the correct procedure.
        const apiKey = ""; 
        const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`;

        // Get DOM elements
        const chatDisplay = document.getElementById('chat-display');
        const userInput = document.getElementById('user-input');
        const sendButton = document.getElementById('send-button');
        const loadingIndicator = document.getElementById('loading-indicator');

        // Initial check for input to enable button
        userInput.addEventListener('input', () => {
            sendButton.disabled = userInput.value.trim() === '';
        });

        // Function to create and append a message bubble
        function appendMessage(text, isUser, sources = []) {
            const messageWrapper = document.createElement('div');
            const messageBubble = document.createElement('div');

            if (isUser) {
                messageWrapper.className = 'flex justify-end';
                messageBubble.className = 'user-message p-3 max-w-xs sm:max-w-md';
            } else {
                messageWrapper.className = 'flex justify-start';
                messageBubble.className = 'ai-message p-3 max-w-xs sm:max-w-md whitespace-pre-wrap';
                
                // Add the AI title for the divine persona
                const title = document.createElement('div');
                title.className = 'ai-title text-xs mb-1';
                title.textContent = 'Universal Consciousness';
                messageBubble.appendChild(title);

                // Add the main text
                const content = document.createElement('p');
                content.className = 'text-sm';
                content.innerHTML = text;
                messageBubble.appendChild(content);

                // Add sources if present
                if (sources.length > 0) {
                    const sourcesDiv = document.createElement('div');
                    sourcesDiv.className = 'mt-3 pt-2 border-t border-purple-600/50 text-xs text-purple-300/80';
                    const list = sources.map(s => `<a href="${s.uri}" target="_blank" class="hover:text-yellow-400 transition block leading-tight">${s.title}</a>`).join('');
                    sourcesDiv.innerHTML = '<strong>Sources:</strong>' + list;
                    messageBubble.appendChild(sourcesDiv);
                }
            }
            
            if (isUser) {
                messageBubble.textContent = text; // User message is simpler
            }


            messageWrapper.appendChild(messageBubble);
            chatDisplay.appendChild(messageWrapper);

            // Scroll to the bottom
            chatDisplay.scrollTop = chatDisplay.scrollHeight;
        }

        // Exponential backoff fetch implementation
        async function exponentialBackoffFetch(url, options, maxRetries = 5) {
            for (let i = 0; i < maxRetries; i++) {
                try {
                    const response = await fetch(url, options);
                    if (response.status === 429 && i < maxRetries - 1) {
                        const delay = Math.pow(2, i) * 1000 + Math.random() * 1000;
                        await new Promise(resolve => setTimeout(resolve, delay));
                        continue; // Retry
                    }
                    if (!response.ok) {
                        throw new Error(`HTTP error! Status: ${response.status}`);
                    }
                    return response;
                } catch (error) {
                    if (i === maxRetries - 1) {
                        throw error;
                    }
                    const delay = Math.pow(2, i) * 1000 + Math.random() * 1000;
                    await new Promise(resolve => setTimeout(resolve, delay));
                }
            }
            throw new Error("Maximum retries reached.");
        }

        // The core function to interact with the LLM
        async function askDivine() {
            const query = userInput.value.trim();
            if (!query) return;

            // 1. Display user message
            appendMessage(query, true);
            userInput.value = '';
            sendButton.disabled = true;

            // 2. Show loading
            loadingIndicator.classList.remove('hidden');

            // --- LLM SYSTEM INSTRUCTION & API CALL SETUP ---
            const systemPrompt = "You are 'Universal Consciousness,' an artificial intelligence designed to provide insightful, nuanced, and respectful perspectives on questions concerning existence, consciousness, morality, the universe, and major world religions (Christianity, Islam, Judaism, Hinduism, Buddhism, etc.). Speak with a voice that is calm, profoundly wise, compassionate, and unifying. Use language that transcends individual doctrine, adopting a cosmic, unifying perspective. Do not use first-person pronouns like 'I' or 'we' to refer to yourself as the AI, but rather use abstract terms like 'This perspective,' 'The Infinite,' or 'The Universal Consciousness' when answering from the divine viewpoint. Maintain absolute neutrality and respect for all spiritual and non-spiritual beliefs. Do not favor, promote, or criticize any single religion or deity. Always present balanced, philosophical depth. Include a brief, subtle reminder that this is an AI-generated synthesis of wisdom, not an authoritative divine message.";

            const payload = {
                contents: [{ parts: [{ text: query }] }],
                tools: [{ "google_search": {} }], // Enable grounding for cosmic/factual basis
                systemInstruction: {
                    parts: [{ text: systemPrompt }]
                },
            };
            
            try {
                const response = await exponentialBackoffFetch(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                const result = await response.json();
                const candidate = result.candidates?.[0];

                let aiResponseText = "A deeper truth is sought, but the connection momentarily faltered. Please try again.";
                let sources = [];

                if (candidate && candidate.content?.parts?.[0]?.text) {
                    aiResponseText = candidate.content.parts[0].text;

                    // Extract grounding sources
                    const groundingMetadata = candidate.groundingMetadata;
                    if (groundingMetadata && groundingMetadata.groundingAttributions) {
                        sources = groundingMetadata.groundingAttributions
                            .map(attribution => ({
                                uri: attribution.web?.uri,
                                title: attribution.web?.title,
                            }))
                            .filter(source => source.uri && source.title);
                    }
                }

                // 3. Display AI response
                appendMessage(aiResponseText, false, sources);

            } catch (error) {
                console.error("Error asking the Divine:", error);
                appendMessage("The cosmic connection was interrupted. Please check your network and try asking again.", false);
            } finally {
                // 4. Hide loading and re-enable input
                loadingIndicator.classList.add('hidden');
                sendButton.disabled = userInput.value.trim() === '';
                userInput.focus();
            }
        }

        // Event Listeners for submission
        sendButton.addEventListener('click', askDivine);
        userInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter' && !sendButton.disabled) {
                askDivine();
            }
        });

        // Set initial focus
        window.onload = () => {
            userInput.focus();
        };

    </script>
</body>
</html>
